<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="data:x-icon," />
</head>

<body>
  <script type="module">
    "use strict";
    (() => {
      let ___store = [];
      window.addEventListener('message', (ev) => {
        if (ev.source !== pt)
          return;
        if (typeof mk !== 'string') {
          if (ev.data.type === 'init.ok') {
            mk = ev.data.mk;
          }
        }
        if (ev.data.mk !== mk)
          return;
        switch (ev.data.type) {
          case 'eval.code': {
            try {
              const result = eval(ev.data.data);
              sendBack({ type: 'eval.result', data: result, msgId: ev.data.msgId, sk })
            } catch (e) {
              sendBack({ type: 'eval.result', error: e, msgId: ev.data.msgId, sk })
            }
            break;
          }
          case 'store.code': {
            try {
              const sonce = '__eval_code_' + Math.random().toString().replace(/\./g, '_');
              const result = (new Function(sonce, `return eval(${sonce})`))(ev.data.data)//阻止代码访问___store
              ___store.push(result);
              sendBack({ type: 'store.index', data: ___store.length - 1, msgId: ev.data.msgId, sk })
            } catch (e) {
              sendBack({ type: 'store.index', error: e, msgId: ev.data.msgId, sk })
            }
            break;
          }
        }
      });
      function sendBack(fullData) {
        parent.postMessage(fullData, '*');
      }
      const pt = parent;
      let mk;
      const sk = (10000000 + Math.floor(Math.random() * 89999999)).toString();
      pt.postMessage({ type: 'init.ok', sk }, '*');
    })();
  </script>
</body>

</html>