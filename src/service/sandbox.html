<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
</head>

<body>
  <script type="module">
    window.globalEval = (code) => {
      const sonce = '__eval_code_' + Math.random().toString().replace(/\./g, '_');
      return (new Function(sonce, `return eval(${sonce})`))(code);
    };
    (() => {
      const ___store = [];
      window.addEventListener('message', async (ev) => {
        if (ev.source !== pt)
          return;
        if (typeof mk !== 'string') {
          if (ev.data.type === 'init.ok') {
            mk = ev.data.mk;
          }
        }
        if (ev.data.mk !== mk)
          return;
        if (ev.data.type !== 'eval.request')
          return;
        const { evalData } = ev.data;
        if (evalData) {
          const { doStore, doAwait, withStore, args, body, doReturn, doMessage, doReturnError } = evalData;
          const useStore = typeof withStore === 'number';
          try {
            const f = new Function(`${useStore ? 'store,' : ''}...args`, body);
            const fargs = useStore ? [___store[withStore], ...args] : [...args];
            let r = f(...fargs);
            if (doAwait)
              r = await r;
            if (doStore)
              ___store.push(r);
            if (doMessage)
              sendBack({ type: 'eval.result', storeIndex: doStore ? ___store.length - 1 : null, evalResult: doReturn ? r : null, msgId: ev.data.msgId, sk })
          } catch (er) {
            if (doMessage)
              sendBack({ type: 'eval.result', error: doReturnError ? er : true, msgId: ev.data.msgId, sk });
          }
        }
      });
      function sendBack(fullData) {
        parent.postMessage(fullData, '*');
      }
      const pt = parent;
      let mk;
      const sk = (10000000 + Math.floor(Math.random() * 89999999)).toString();
      pt.postMessage({ type: 'init.ok', sk }, '*');
    })();
  </script>
</body>

</html>